#!/bin/bash

# Forge Features CLI - Centralized Feature Management
# Controls features across all Forge projects (MCP Gateway, UIForge MCP, UIForge WebApp)

set -e

# Default configuration
UNLEASH_URL=${UNLEASH_URL:-"http://localhost:4242"}
UNLEASH_API_URL="${UNLEASH_URL}/api"
CLIENT_KEY=${CLIENT_KEY:-"default:development"}
CONFIG_FILE="${FORGE_PATTERNS_DIR:-$(pwd)}/patterns/config/patterns-config.yml"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Print functions
print_success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

print_error() {
    echo -e "${RED}‚ùå $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"
}

print_info() {
    echo -e "${BLUE}‚ÑπÔ∏è  $1${NC}"
}

# Help function
show_help() {
    cat << EOF
Forge Features CLI - Centralized Feature Management

USAGE:
    forge-features <command> [feature-name] [options]

COMMANDS:
    enable <feature>     Enable a feature
    disable <feature>    Disable a feature
    status              Show feature status
    list                List all available features
    help                Show this help message

FEATURE NAMES:
    Global features: global.debug-mode, global.beta-features, global.experimental-ui, global.enhanced-logging
    MCP Gateway: mcp-gateway.rate-limiting, mcp-gateway.request-validation, mcp-gateway.security-headers
    UIForge MCP: uiforge-mcp.ai-chat, uiforge-mcp.template-management, uiforge-mcp.ui-generation
    UIForge WebApp: uiforge-webapp.dark-mode, uiforge-webapp.advanced-analytics

OPTIONS:
    --project <name>    Filter by project (mcp-gateway, uiforge-mcp, uiforge-webapp)
    --global            Show only global features
    --local             Use local Unleash instance (default)

EXAMPLES:
    forge-features enable global.debug-mode
    forge-features disable mcp-gateway.rate-limiting
    forge-features status --project=mcp-gateway
    forge-features status --global
    forge-features list

ENVIRONMENT VARIABLES:
    UNLEASH_URL         Unleash instance URL (default: http://localhost:4242)
    CLIENT_KEY          Unleash client API key (default: default:development)

EOF
}

# Check if Unleash is running
check_unleash() {
    if ! curl -s "${UNLEASH_API_URL}/health" > /dev/null 2>&1; then
        print_error "Unleash instance not reachable at ${UNLEASH_URL}"
        print_info "Start Unleash with: docker run -p 4242:4242 unleashorg/unleash-server"
        exit 1
    fi
}

# Get feature list from configuration
get_config_features() {
    if [[ -f "$CONFIG_FILE" ]]; then
        # Extract global features
        local global_features=$(grep -A 10 "global_features_list:" "$CONFIG_FILE" | grep "^\s*-" | sed 's/^\s*-\s*//' || true)
        
        # Extract project features
        local project_features=""
        while IFS= read -r project; do
            local features=$(grep -A 20 "$project:" "$CONFIG_FILE" | grep "^\s*-" | sed 's/^\s*-\s*//' | sed "s/^/$project./" || true)
            project_features="$project_features$features"$'\n'
        done <<< "$(grep -E "^\s*[a-z-]+:$" "$CONFIG_FILE" | grep -v "global_features_list:" | sed 's/^\s*//' | sed 's/:$//' || true)"
        
        echo -e "Global Features:"$'\n'"$global_features"$'\n'"$'\n'"Project Features:"$'\n'"$project_features"
    else
        print_warning "Configuration file not found: $CONFIG_FILE"
        echo "Using default feature list"
    fi
}

# Enable a feature
enable_feature() {
    local feature="$1"
    print_info "Enabling feature: $feature"
    
    # Create feature if it doesn't exist
    local create_response=$(curl -s -X POST "${UNLEASH_API_URL}/admin/features" \
        -H "Authorization: ${CLIENT_KEY}" \
        -H "Content-Type: application/json" \
        -d "{
            \"name\": \"$feature\",
            \"description\": \"Feature $feature managed by Forge Features CLI\",
            \"type\": \"release\",
            \"enabled\": true,
            \"strategies\": [
                {
                    \"name\": \"default\",
                    \"parameters\": {}
                }
            ]
        }" 2>/dev/null || true)
    
    # Enable the feature
    local enable_response=$(curl -s -X PATCH "${UNLEASH_API_URL}/admin/features/$feature" \
        -H "Authorization: ${CLIENT_KEY}" \
        -H "Content-Type: application/json" \
        -d "{\"enabled\": true}" 2>/dev/null)
    
    if [[ $? -eq 0 ]]; then
        print_success "Feature '$feature' enabled successfully"
    else
        print_error "Failed to enable feature '$feature'"
        exit 1
    fi
}

# Disable a feature
disable_feature() {
    local feature="$1"
    print_info "Disabling feature: $feature"
    
    local response=$(curl -s -X PATCH "${UNLEASH_API_URL}/admin/features/$feature" \
        -H "Authorization: ${CLIENT_KEY}" \
        -H "Content-Type: application/json" \
        -d "{\"enabled\": false}" 2>/dev/null)
    
    if [[ $? -eq 0 ]]; then
        print_success "Feature '$feature' disabled successfully"
    else
        print_error "Failed to disable feature '$feature'"
        exit 1
    fi
}

# Show feature status
show_status() {
    local project_filter="$1"
    local global_only="$2"
    
    print_info "Fetching feature status from ${UNLEASH_URL}"
    
    local response=$(curl -s "${UNLEASH_API_URL}/admin/features" \
        -H "Authorization: ${CLIENT_KEY}" 2>/dev/null)
    
    if [[ $? -ne 0 ]]; then
        print_error "Failed to fetch feature status"
        exit 1
    fi
    
    echo ""
    echo "üéõÔ∏è  Feature Status"
    echo "=================="
    
    # Parse and display features
    echo "$response" | jq -r '.features[] | "\(.name):\(.enabled)"' 2>/dev/null | while IFS=: read -r name enabled; do
        if [[ "$enabled" == "true" ]]; then
            echo -e "${GREEN}‚úÖ $name${NC}"
        else
            echo -e "${RED}‚ùå $name${NC}"
        fi
    done || {
        print_warning "Could not parse feature status. Make sure jq is installed."
        echo "$response"
    }
}

# List available features
list_features() {
    echo ""
    echo "üìã Available Features"
    echo "===================="
    
    local config_features=$(get_config_features)
    echo "$config_features"
}

# Main script logic
main() {
    case "${1:-}" in
        "enable")
            if [[ -z "${2:-}" ]]; then
                print_error "Feature name required"
                echo "Usage: forge-features enable <feature-name>"
                exit 1
            fi
            check_unleash
            enable_feature "$2"
            ;;
        "disable")
            if [[ -z "${2:-}" ]]; then
                print_error "Feature name required"
                echo "Usage: forge-features disable <feature-name>"
                exit 1
            fi
            check_unleash
            disable_feature "$2"
            ;;
        "status")
            local project_filter=""
            local global_only=""
            
            # Parse arguments
            shift
            while [[ $# -gt 0 ]]; do
                case $1 in
                    --project=*)
                        project_filter="${1#*=}"
                        shift
                        ;;
                    --project)
                        project_filter="$2"
                        shift 2
                        ;;
                    --global)
                        global_only="true"
                        shift
                        ;;
                    *)
                        print_error "Unknown option: $1"
                        exit 1
                        ;;
                esac
            done
            
            check_unleash
            show_status "$project_filter" "$global_only"
            ;;
        "list")
            list_features
            ;;
        "help"|"--help"|"-h")
            show_help
            ;;
        "")
            print_error "Command required"
            echo "Use 'forge-features help' for usage information"
            exit 1
            ;;
        *)
            print_error "Unknown command: $1"
            echo "Use 'forge-features help' for usage information"
            exit 1
            ;;
    esac
}

# Run main function with all arguments
main "$@"
