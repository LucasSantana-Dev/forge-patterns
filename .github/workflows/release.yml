name: Automated Release

on:
  push:
    branches: [main]
    tags:
      - 'release/*.*.*'

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  detect-release:
    name: Detect Release Branch Merge
    runs-on: ubuntu-latest
    outputs:
      is-release: ${{ steps.check.outputs.is-release }}
      version: ${{ steps.check.outputs.version }}
      should-publish: ${{ steps.check.outputs.should-publish }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check if this is a release merge
        id: check
        run: |
          # Check if the latest commit is a merge from a release branch
          if [[ "${{ github.ref }}" == refs/tags/release/*.*.* ]]; then
            echo "is-release=true" >> $GITHUB_OUTPUT
            echo "version=$(echo "${{ github.ref_name }}" | sed 's|^release/||')" >> $GITHUB_OUTPUT
            echo "should-publish=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            # Check if the latest commit message indicates a release merge
            COMMIT_MSG=$(git log -1 --pretty=format:"%s")
            if [[ "$COMMIT_MSG" =~ ^Merge\ branch\ .*/release/.*\..*\..* ]]; then
              echo "is-release=true" >> $GITHUB_OUTPUT
              # Extract version from branch name in commit message - fixed regex
              VERSION=$(echo "$COMMIT_MSG" | sed -E 's|.*release/([0-9]+\.[0-9]+\.[0-9]+).*|\1|')
              echo "version=$VERSION" >> $GITHUB_OUTPUT
              echo "should-publish=true" >> $ITHUB_OUTPUT
            else
              echo "is-release=false" >> $GITHUB_OUTPUT
              echo "should-publish=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "is-release=false" >> $GITHUB_OUTPUT
            echo "should-publish=false" >> $GITHUB_OUTPUT
          fi

  quality-checks:
    name: Run Quality Checks
    runs-on: ubuntu-latest
    needs: detect-release
    if: needs.detect-release.outputs.is-release == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint:check

      - name: Check formatting
        run: npm run format:check

      - name: TypeScript compilation
        run: npx tsc --noEmit

      - name: Run tests
        run: npm test

      - name: Security audit
        run: npm audit --audit-level high --omit=dev || true

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: detect-release
    if: needs.detect-release.outputs.is-release == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install dependencies
        run: npm ci

      - name: NPM Audit
        run: npm audit --audit-level=high --omit=dev || true

  update-version:
    name: Update Package Version
    runs-on: ubuntu-latest
    needs: [detect-release, quality-checks, security-scan]
    if: needs.detect-release.outputs.is-release == 'true' && needs.detect-release.outputs.should-publish == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Update package.json version
        run: npm version ${{ needs.detect-release.outputs.version }} --no-git-tag-version

      - name: Update CHANGELOG
        run: |
          VERSION="${{ needs.detect-release.outputs.version }}"
          DATE=$(date +%Y-%m-%d)

          # Create changelog entry
          ENTRY="## [$VERSION] - $DATE

          ### Features
          - Automated release pipeline integration
          - Forge-context MCP server integration
          - Updated shared constants and internal imports

          ### Fixes
          - Fixed module resolution issues
          - Resolved TypeScript compilation errors
          - Fixed MCP server startup issues

          ### Documentation
          - Updated integration guides
          - Added deployment automation documentation

          ---


          "

          # Insert at the beginning of CHANGELOG.md (after any header) - fixed logic
          if [ -f "CHANGELOG.md" ]; then
            # Read existing content
            EXISTING=$(cat CHANGELOG.md)
            # Find the line number of the first "## " heading
            HEADING_LINE=$(echo "$EXISTING" | grep -n "^## " | head -1 | cut -d: -f1)
            if [ -n "$HEADING_LINE" ]; then
              # Insert after the first ## heading
              head -n $HEADING_LINE CHANGELOG.md > temp_changelog.md
              echo "$ENTRY" >> temp_changelog.md
              tail -n +$((HEADING_LINE + 1)) CHANGELOG.md >> temp_changelog.md
              mv temp_changelog.md CHANGELOG.md
            else
              # Insert at beginning
              echo "$ENTRY" > temp_changelog.md
              echo "$EXISTING" >> temp_changelog.md
              mv temp_changelog.md CHANGELOG.md
            fi
          else
            echo "$ENTRY" > CHANGELOG.md
          fi

      - name: Commit version changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add package.json package-lock.json CHANGELOG.md
          git commit -m "chore(release): bump version to ${{ needs.detect-release.outputs.version }}"

      - name: Push changes
        run: |
          # Use a token with bypass permissions for branch protection
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_BYPASS_TOKEN || secrets.GITHUB_TOKEN }}

  publish-npm:
    name: Publish to npm
    runs-on: ubuntu-latest
    needs: [detect-release, quality-checks, security-scan, update-version]
    if: needs.detect-release.outputs.should-publish == 'true'
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Fetch latest changes after version bump
        run: |
          git fetch origin main
          git reset --hard origin/main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          registry-url: 'https://registry.npmjs.org/'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Publish to npm
        run: npm publish --access public --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  create-github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [detect-release, publish-npm]
    if: needs.detect-release.outputs.should-publish == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ needs.detect-release.outputs.version }}
          release_name: Release v${{ needs.detect-release.outputs.version }}
          draft: false
          prerelease: false
          body: |
            ## Release v${{ needs.detect-release.outputs.version }}

            This release includes:
            - Forge-context MCP server integration
            - Updated shared constants and internal imports
            - Automated release pipeline
            - Various bug fixes and improvements

            ### Installation
            ```bash
            npm install @forgespace/core@${{ needs.detect-release.outputs.version }}
            ```

            ### Changes
            See the [CHANGELOG.md](https://github.com/Forge-Space/core/blob/main/CHANGELOG.md) for detailed changes.

  notify-teams:
    name: Notify Teams
    runs-on: ubuntu-latest
    needs: [detect-release, publish-npm, create-github-release]
    if: always() && needs.detect-release.outputs.should-publish == 'true'

    steps:
      - name: Notify Success
        if: needs.publish-npm.result == 'success' && needs.create-github-release.result == 'success'
        run: |
          echo "‚úÖ Release v${{ needs.detect-release.outputs.version }} published successfully!"
          echo "üì¶ npm package: https://www.npmjs.com/package/@forgespace/core/v/${{ needs.detect-release.outputs.version }}"
          echo "üè∑Ô∏è GitHub release: https://github.com/Forge-Space/core/releases/tag/v${{ needs.detect-release.outputs.version }}"

      - name: Notify Failure
        if: needs.publish-npm.result == 'failure' || needs.create-github-release.result == 'failure'
        run: |
          echo "‚ùå Release v${{ needs.detect-release.outputs.version }} failed!"
          echo "Check the workflow logs for details."
