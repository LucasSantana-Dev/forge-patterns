name: Branch Protection and Release Rules

on:
  push:
    branches: [main]
  pull_request:
    branches: [main, "release/*"]
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-release-branch:
    name: Validate Release Branch
    runs-on: ubuntu-latest
    if: startsWith(github.head_ref, 'release/')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate release branch name
        id: validate
        run: |
          BRANCH="${{ github.head_ref }}"
          if [[ ! "$BRANCH" =~ ^release/[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "❌ Release branch name must follow pattern: release/X.Y.Z"
            echo "Current branch: $BRANCH"
            exit 1
          fi

          VERSION=$(echo "$BRANCH" | sed 's|release/||')
          echo "✅ Valid release version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Check version format
        run: |
          VERSION="${{ steps.validate.outputs.version }}"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "❌ Version must be semantic: X.Y.Z"
            exit 1
          fi

      - name: Check for existing releases
        run: |
          VERSION="${{ steps.validate.outputs.version }}"
          if git tag -l "v$VERSION" | grep -q .; then
            echo "❌ Version v$VERSION already exists"
            exit 1
          fi

  enforce-pr-requirements:
    name: Enforce PR Requirements
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR description
        env:
          DESCRIPTION: "${{ github.event.pull_request.body }}"
        run: |
          # Safely handle the description from environment variable
          DESCRIPTION="$(printf '%s' "$DESCRIPTION")"
          if [[ -z "$DESCRIPTION" || ${#DESCRIPTION} -lt 20 ]]; then
            echo "❌ PR must have a description (at least 20 characters)"
            exit 1
          fi

      - name: Check for tests
        run: |
          # Check if PR adds or modifies code that should have tests
          FILES_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}..HEAD)
          HAS_CODE_CHANGES=false
          HAS_TEST_CHANGES=false

          for FILE in $FILES_CHANGED; do
            if [[ "$FILE" =~ \.(ts|js|tsx|jsx)$ ]] && [[ ! "$FILE" =~ test|spec ]]; then
              HAS_CODE_CHANGES=true
            fi
            if [[ "$FILE" =~ \.(test|spec)\.(ts|js|tsx|jsx)$ ]]; then
              HAS_TEST_CHANGES=true
            fi
          done

          if [[ "$HAS_CODE_CHANGES" == "true" && "$HAS_TEST_CHANGES" == "false" ]]; then
            echo "⚠️ Consider adding tests for code changes"
            echo "This is a warning, not blocking the PR"
          fi

      - name: Check CHANGELOG updates
        run: |
          if [[ "${{ github.base_ref }}" == "main" ]]; then
            FILES_CHANGED=$(git diff --name-only origin/main..HEAD)
            if echo "$FILES_CHANGED" | grep -qE "\.(ts|js|tsx|jsx)$" && ! echo "$FILES_CHANGED" | grep -q "CHANGELOG.md"; then
              echo "⚠️ Consider updating CHANGELOG.md for user-facing changes"
              echo "This is a warning, not blocking the PR"
            fi
          fi

  pre-commit:
    name: Pre-commit Checks
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint

      - name: Run type checking
        run: npm run type-check

      - name: Run tests
        run: npm test

      - name: Security audit
        run: npm audit --audit-level high

  docs-validation:
    name: Documentation Validation
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check README exists
        run: |
          if [[ ! -f README.md ]]; then
            echo "❌ README.md is required"
            exit 1
          fi

      - name: Validate README structure
        run: |
          # Check for basic README sections
          README_CONTENT=$(cat README.md)
          REQUIRED_SECTIONS=("Installation" "Usage" "Contributing")

          for SECTION in "${REQUIRED_SECTIONS[@]}"; do
            if ! echo "$README_CONTENT" | grep -q "$SECTION"; then
              echo "❌ README.md missing $SECTION section"
              exit 1
            fi
          done

      - name: Check API documentation
        run: |
          # Check if there are API docs
          if [[ -d docs ]]; then
            echo "✅ Documentation directory found"

            # Check for index file
            if [[ ! -f docs/index.md && ! -f docs/README.md ]]; then
              echo "⚠️ Consider adding docs/index.md or docs/README.md"
            fi
          else
            echo "⚠️ Consider adding docs/ directory for API documentation"
          fi

      - name: Validate CHANGELOG
        run: |
          if [[ -f CHANGELOG.md ]]; then
            # Check CHANGELOG format
            if ! head -10 CHANGELOG.md | grep -q "^## "; then
              echo "❌ CHANGELOG.md should start with version headers (## [version])"
              exit 1
            fi
          else
            echo "⚠️ Consider adding CHANGELOG.md for version history"
          fi

  enforce-main-merge-policy:
    name: Enforce Main Merge Policy
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.base_ref == 'main'

    steps:
      - name: Only release branches may merge to main
        run: |
          BRANCH="${{ github.head_ref }}"
          if [[ ! "$BRANCH" =~ ^release/[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "❌ Only release/X.Y.Z branches may merge directly to main"
            echo "Current branch: $BRANCH"
            echo ""
            echo "Required flow: feature/* or fix/* → release/X.Y.Z → main"
            exit 1
          fi
          echo "✅ Release branch confirmed: $BRANCH"

  release-validation:
    name: Release Validation
    runs-on: ubuntu-latest
    if: startsWith(github.head_ref, 'release/')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run full test suite
        run: npm test

      - name: Run security scan
        run: npm audit --audit-level high

      - name: Check build
        run: npm run build

      - name: Validate package.json
        run: |
          # Check that package.json is valid
          if ! npm ls --json >/dev/null 2>&1; then
            echo "❌ package.json has dependency issues"
            exit 1
          fi

      - name: Check for breaking changes
        run: |
          VERSION="${{ github.head_ref }}"
          VERSION=${VERSION#release/}

          # Extract major version
          MAJOR=$(echo "$VERSION" | cut -d. -f1)

          # Get last released version
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          LAST_VERSION=${LAST_TAG#v}
          LAST_MAJOR=$(echo "$LAST_VERSION" | cut -d. -f1)

          if [[ "$MAJOR" -gt "$LAST_MAJOR" ]]; then
            echo "⚠️ This is a major version bump ($LAST_VERSION -> $VERSION)"
            echo "Ensure breaking changes are documented"
          fi
