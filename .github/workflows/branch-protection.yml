name: Branch Protection

on:
  pull_request:
    branches: [main, develop]

jobs:
  check-branch-protection:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check branch name follows conventions
        run: |
          BRANCH_NAME=${GITHUB_HEAD_REF}
          echo "Checking branch: $BRANCH_NAME"

          if [[ "$BRANCH_NAME" =~ ^(main|develop)$ ]]; then
            echo "Branch is a protected branch: $BRANCH_NAME"
            exit 0
          fi

          if [[ "$BRANCH_NAME" =~ ^(feature|fix|hotfix|chore|docs|refactor|test|perf)/.+ ]]; then
            echo "Branch follows naming convention: $BRANCH_NAME"
            exit 0
          fi

          echo "Branch name does not follow conventions: $BRANCH_NAME"
          echo "Expected: feature/*, fix/*, hotfix/*, chore/*, docs/*, refactor/*, test/*, perf/*"
          exit 1

      - name: Check commit messages follow Angular convention
        run: |
          echo "Checking commit messages..."
          FAILED=0
          ANGULAR_TYPES="feat|fix|docs|style|refactor|perf|test|chore|build|ci|revert"

          while IFS= read -r COMMIT; do
            echo "Checking: $COMMIT"
            if echo "$COMMIT" | grep -qE "^($ANGULAR_TYPES)(\([^)]+\))?: .+"; then
              echo "OK: $COMMIT"
            else
              echo "FAIL: $COMMIT does not follow Angular convention"
              echo "Expected: type(scope): description"
              FAILED=1
            fi
          done < <(git log --pretty=format:"%s" origin/main..HEAD)

          if [ "$FAILED" -eq 1 ]; then
            exit 1
          fi

      - name: Check for merge commits
        run: |
          echo "Checking for merge commits..."

          MERGE_COMMITS=$(git log --oneline --merges origin/main..HEAD | wc -l)

          if [ "$MERGE_COMMITS" -gt 0 ]; then
            echo "Found $MERGE_COMMITS merge commits in PR"
            echo "Please rebase to avoid merge commits"
            exit 1
          else
            echo "No merge commits found"
          fi

      - name: Check file size limits
        run: |
          echo "Checking file sizes..."

          LARGE_FILES=$(find . -type f -not -path "./.git/*" -not -path "./node_modules/*" -size +1M)

          if [ -n "$LARGE_FILES" ]; then
            echo "Found large files:"
            echo "$LARGE_FILES"
            echo "Please keep files under 1MB or use Git LFS"
            exit 1
          else
            echo "No large files found"
          fi

  validate-tbd-workflow:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate Trunk Based Development workflow
        run: |
          echo "Validating TBD workflow..."

          if [ "$GITHUB_BASE_REF" = "main" ]; then
            echo "Working against trunk (main)"

            BEHIND=$(git rev-list --count HEAD..origin/main)
            if [ "$BEHIND" -gt 0 ]; then
              echo "Branch is $BEHIND commits behind main"
              echo "Please sync with main before creating PR"
              exit 1
            else
              echo "Branch is up to date with main"
            fi
          else
            echo "Not targeting main branch"
          fi

      - name: Check for long-lived branches
        run: |
          echo "Checking branch age..."

          BRANCH_AGE=$(git log --since="2 weeks ago" --pretty=format:"%h" | wc -l)

          if [ "$BRANCH_AGE" -eq 0 ]; then
            echo "Branch is older than 2 weeks - consider merging or updating"
          else
            echo "Branch is recent"
          fi
